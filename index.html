<script>
let currentPage = 1;
const pageSize = 6; // 每页显示条数
let onlyOP = false;
const OP_NAME = "我家狗狗可爱";
let postsData = []; // 当前页数据或累积数据

function getLevel(points){
    if(points>2000) return "资深居民";
    if(points>1000) return "常驻居民";
    if(points>300) return "小镇居民";
    return "新居民";
}

function randomIP(){
    return "IP: 192.168."+Math.floor(Math.random()*255)+"."+Math.floor(Math.random()*255);
}

function goHome(){ window.location.href="home.html"; }
function toggleOP(val=true){ onlyOP=val; render(postsData); }
function quotePost(floor){
    document.getElementById("quoteArea").innerHTML=`
    <div class="quote-box">
    引用 ${floor}楼：
    <br>（内容略）
    </div>`;
}

/* 动态加载分页 JS 文件 */
function loadPage(page){
    currentPage = page;

    const oldScript = document.getElementById("pageScript");
    if(oldScript) oldScript.remove();

    const script = document.createElement("script");
    script.id = "pageScript";
    script.src = "page" + page + ".js?"+Date.now(); // 防止缓存
    document.body.appendChild(script);
}

/* 渲染当前页数据 */
function render(data){
    postsData = data;
    const container = document.getElementById("posts");
    container.innerHTML = "";

    const filtered = onlyOP ? postsData.filter(p=>p.name===OP_NAME) : postsData;
    const start = (currentPage-1) * pageSize;

    filtered.forEach((p,i)=>{
        const floorNumber = start + i + 1;
        const isOP = p.name===OP_NAME;
        const nameHTML = `<div class="username">${p.name || '匿名'}${isOP?'（楼主）':''}</div>`;

        const post = document.createElement("div");
        post.className = "post";
        post.innerHTML = `
            ${nameHTML}
            <div class="meta-user">
                积分 ${p.points||0} ｜ ${getLevel(p.points||0)} ｜ ${randomIP()}
            </div>
            <div class="floor">
                ${floorNumber}楼 ｜ 发表于 ${p.time}
            </div>
            <div class="content ${p.deleted?'deleted':''}">
                ${p.deleted?'该帖已被删除':p.content.replace(/\n/g,'<br>')}
            </div>
            <div class="actions">
                ${!p.deleted?`<span onclick="quotePost(${floorNumber})">引用</span>
                <span style="color:#b5a79a;">举报</span>`:''}
            </div>
        `;
        container.appendChild(post);
    });

    renderPages(filtered.length);
}

/* 分页条 */
function renderPages(totalItems){
    const bar = document.getElementById("pagebar");
    bar.innerHTML = "";
    const totalPages = Math.ceil(totalItems/pageSize);
    for(let i=1;i<=totalPages;i++){
        const span = document.createElement("span");
        span.innerText = i;
        if(i===currentPage) span.style.fontWeight="bold";
        span.onclick = ()=>{ loadPage(i); };
        bar.appendChild(span);
    }
}

/* 初始加载第一页 */
loadPage(1);
</script>
